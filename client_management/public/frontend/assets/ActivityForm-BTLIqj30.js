var ae=Object.defineProperty,le=Object.defineProperties;var te=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var se=Object.prototype.hasOwnProperty,oe=Object.prototype.propertyIsEnumerable;var $=(c,u,r)=>u in c?ae(c,u,{enumerable:!0,configurable:!0,writable:!0,value:r}):c[u]=r,O=(c,u)=>{for(var r in u||(u={}))se.call(u,r)&&$(c,r,u[r]);if(M)for(var r of M(u))oe.call(u,r)&&$(c,r,u[r]);return c},R=(c,u)=>le(c,te(u));var y=(c,u,r)=>new Promise((s,F)=>{var E=m=>{try{g(r.next(m))}catch(b){F(b)}},w=m=>{try{g(r.throw(m))}catch(b){F(b)}},g=m=>m.done?s(m.value):Promise.resolve(m.value).then(E,w);g((r=r.apply(c,u)).next())});import{j as ne,r as h,v as ie,c as U,a as _,k as f,t as S,b as p,d as i,u as n,F as re,l as ue,w as A,i as de,a9 as ce,e as me,o as v,I as k,n as N,p as T,g as x,m as q,q as _e}from"./index-BQMqF1jf.js";const pe={class:"max-w-3xl mx-auto p-6"},ve={key:0,class:"text-center py-8"},ye={key:1,class:"mb-4 p-4 bg-red-100 text-red-700 rounded-md"},ge={key:2,class:"mb-4 p-4 bg-green-100 text-green-700 rounded-md"},he={key:3,class:"card"},fe={class:"grid grid-cols-2 gap-4 mb-6"},be={class:"col-span-2"},Ve={key:0,class:"col-span-2"},we={class:"col-span-2"},Ce={key:0,class:"absolute top-2 right-2"},Ue={class:"card-header"},Te={class:"card-body"},ke={key:0,class:"mb-4"},Fe={key:1,class:"mb-4"},Ae={class:"mb-4"},xe={class:"grid grid-cols-3 gap-4 mb-4"},qe={class:"grid grid-cols-3 gap-4 mb-4"},Ee={class:"flex gap-3"},Pe={__name:"ActivityForm",setup(c){const u=ce(),r=me(),s=h({template_name:"",is_recurring:!1,recurring_day:null,client:"",tasks:[]}),F=Array.from({length:31},(l,a)=>({label:(a+1).toString(),value:a+1})),E=[{label:"Low",value:"Low"},{label:"Medium",value:"Medium"},{label:"High",value:"High"}],w=h([{label:"Select Client",value:""}]),g=h([]),m=h([]),b=h(!0),V=h(!1),P=h(!1),d=h("");ie(()=>y(this,null,function*(){try{yield Promise.all([L(),B(),z()])}catch(l){d.value="Initialization failed: "+(l.message||"Unknown error")}}));const L=()=>y(this,null,function*(){b.value=!0;try{const a=yield U({url:"frappe.client.get",params:{doctype:"Template",name:u.params.templateName,fields:["*"]}}).fetch(),e={};a.tasks.forEach((t,o)=>{e[t.name]=o}),s.value={template_name:a.template_name,is_recurring:!1,recurring_day:null,client:"",tasks:a.tasks.map(t=>R(O({},t),{is_child:!!t.parent_task,parent_task:t.parent_task?e[t.parent_task]:null,assign_to:"",priority:"Medium"}))},s.value.tasks.length===0&&s.value.tasks.push(D())}catch(l){d.value=l.message||"Failed to load template data"}finally{b.value=!1}}),D=()=>({task_name:"",task_type:"",complete_within_days:1,from_date:"",to_date:"",description:"",is_child:!1,parent_task:null,assign_to:"",priority:"Medium",hide_to_client:!1}),B=()=>y(this,null,function*(){try{const a=yield U({url:"frappe.client.get_list",params:{doctype:"ClientFormData",fields:["name","client_name"]}}).fetch();console.log("Full response:",a);const e=a.message||a.result||(Array.isArray(a)?a:[]);w.value=[{label:"Select Client",value:""},...e.map(t=>({label:t.client_name,value:t.name}))],console.log("Options:",w.value)}catch(l){console.error("Failed to load clients:",l),d.value="Failed to load client list. Please check your permissions.",w.value=[{label:"Failed to load clients",value:""}]}}),H=()=>y(this,null,function*(){if(!s.value.template_name)return;(yield I(s.value.template_name))?d.value="An activity with this name already exists. Please choose a different name.":d.value=""}),I=l=>y(this,null,function*(){try{return(yield U({url:"frappe.client.get_list",params:{doctype:"Activity",filters:[["activity_name","=",l]],limit:1}}).fetch()).length>0}catch(a){return console.error("Error checking activity name:",a),!1}}),z=()=>y(this,null,function*(){try{const a=yield U({url:"client_management.client_management.doctype.activity.activity.get_users_for_assignment",method:"GET"}).fetch();if(console.log(a,"Raw response"),a.success)console.log(a.internal_users,"users"),m.value=a.internal_users.map(e=>({label:e.full_name||e.name,value:e.name}));else throw console.log("Error in response"),new Error(a.message||"Failed to load users")}catch(l){console.error("Failed to load internal users:",l),d.value="Failed to load user list. Please check your permissions.",m.value=[{label:"Failed to load users",value:""}]}}),W=l=>y(this,null,function*(){if(!l){g.value=[];return}try{const e=yield U({url:"client_management.client_management.doctype.activity.activity.get_client_users",method:"POST",params:{client_id:l}}).fetch();if(console.log(e,"clientchange"),e.success)g.value=e.users.map(t=>({label:t.full_name||t.name,value:t.name}));else throw new Error(data.message||"Failed to load client users")}catch(a){console.error("Failed to load client users:",a),d.value="Failed to load client users. Please check your permissions.",g.value=[{label:"Failed to load client users",value:""}]}}),j=l=>{const a=[{label:"Select User",value:""}];return l==="Internal"?[...a,...m.value]:l==="Client"?[...a,...g.value]:a},G=l=>{s.value.tasks[l].assign_to=""},J=()=>{s.value.is_recurring||(s.value.recurring_day=null)},K=l=>{l.is_child&&(l.from_date="",l.to_date="",l.parent_task=null)},Q=l=>s.value.tasks.slice(0,l),X=()=>{s.value.tasks.push(D())},Y=l=>{s.value.tasks.splice(l,1)},Z=()=>y(this,null,function*(){V.value=!0,P.value=!1,d.value="";try{if(!s.value.template_name){d.value="Activity Name is required",V.value=!1;return}if(yield I(s.value.template_name)){d.value="An activity with this name already exists. Please choose a different name.",V.value=!1;return}const a=s.value.tasks.map((t,o)=>{const C={task_name:t.task_name,task_type:t.task_type,complete_within_days:t.complete_within_days,description:t.description,is_child:t.is_child||!1,parent_index:t.is_child?t.parent_task:null,assign_to:t.assign_to,priority:t.priority,client:s.value.client,hide_to_client:t.hide_to_client||!1};return t.is_child||(C.from_date=t.from_date,C.to_date=t.to_date),C});yield U({url:"client_management.client_management.doctype.activity.activity.create_activity_from_template",method:"POST",params:{template_name:s.value.template_name,client:s.value.client,is_recurring:s.value.is_recurring,recurring_day:s.value.recurring_day,tasks:a}}).submit(),P.value=!0,setTimeout(()=>{r.push({name:"ActivityList"})},1500)}catch(l){d.value=l.message||"Failed to create activity"}finally{V.value=!1}}),ee=()=>{r.go(-1)};return(l,a)=>(v(),_("div",pe,[b.value&&!s.value.template_name?(v(),_("div",ve," Loading template data... ")):f("",!0),d.value?(v(),_("div",ye,S(d.value),1)):f("",!0),P.value?(v(),_("div",ge," Activity created successfully! ")):f("",!0),s.value.template_name?(v(),_("div",he,[a[8]||(a[8]=p("h2",{class:"card-header"},"Create Activity from Template",-1)),p("form",{onSubmit:de(Z,["prevent"]),class:"card-body"},[i(n(k),{label:"Activity Name",modelValue:s.value.template_name,"onUpdate:modelValue":a[0]||(a[0]=e=>s.value.template_name=e),type:"text",class:"mb-4",onBlur:H},null,8,["modelValue"]),p("div",fe,[p("div",be,[i(n(N),{modelValue:s.value.is_recurring,"onUpdate:modelValue":a[1]||(a[1]=e=>s.value.is_recurring=e),label:"Is Recurring Activity",onChange:J},null,8,["modelValue"])]),s.value.is_recurring?(v(),_("div",Ve,[i(n(T),{modelValue:s.value.recurring_day,"onUpdate:modelValue":a[2]||(a[2]=e=>s.value.recurring_day=e),options:n(F),label:"Select day of the month",required:""},null,8,["modelValue","options"])])):f("",!0),p("div",we,[i(n(T),{modelValue:s.value.client,"onUpdate:modelValue":a[3]||(a[3]=e=>s.value.client=e),options:w.value,label:"Client",required:"",onChange:a[4]||(a[4]=e=>W(e.target.value))},null,8,["modelValue","options"])])]),(v(!0),_(re,null,ue(s.value.tasks,(e,t)=>(v(),_("div",{key:t,class:"card mb-4 relative"},[t>0?(v(),_("div",Ce,[i(n(q),{onClick:o=>Y(t),variant:"ghost",size:"sm"},{default:A(()=>a[5]||(a[5]=[x(" Remove ")])),_:2,__:[5]},1032,["onClick"])])):f("",!0),p("h3",Ue,"Task "+S(t+1),1),p("div",Te,[t>0?(v(),_("div",ke,[i(n(N),{modelValue:e.is_child,"onUpdate:modelValue":o=>e.is_child=o,onChange:o=>K(e),label:"Is Child Task"},null,8,["modelValue","onUpdate:modelValue","onChange"])])):f("",!0),e.is_child?(v(),_("div",Fe,[i(n(T),{modelValue:e.parent_task,"onUpdate:modelValue":o=>e.parent_task=o,options:[{label:"Select Parent Task",value:null},...Q(t).map((o,C)=>({label:o.task_name||`Task ${C+1}`,value:C}))],label:"Parent Task",required:""},null,8,["modelValue","onUpdate:modelValue","options"])])):f("",!0),p("div",Ae,[i(n(N),{modelValue:e.hide_to_client,"onUpdate:modelValue":o=>e.hide_to_client=o,label:"Hide this task from client view"},null,8,["modelValue","onUpdate:modelValue"])]),i(n(k),{label:"Task Name",modelValue:e.task_name,"onUpdate:modelValue":o=>e.task_name=o,type:"text",required:"",class:"mb-4"},null,8,["modelValue","onUpdate:modelValue"]),p("div",xe,[i(n(T),{modelValue:e.task_type,"onUpdate:modelValue":o=>e.task_type=o,options:[{label:"Task Type",value:""},{label:"Internal",value:"Internal"},{label:"Client",value:"Client"}],required:"",onChange:o=>G(t)},null,8,["modelValue","onUpdate:modelValue","onChange"]),i(n(T),{modelValue:e.assign_to,"onUpdate:modelValue":o=>e.assign_to=o,options:j(e.task_type),label:"Assign To",required:""},null,8,["modelValue","onUpdate:modelValue","options"]),i(n(T),{modelValue:e.priority,"onUpdate:modelValue":o=>e.priority=o,options:E,label:"Priority",required:""},null,8,["modelValue","onUpdate:modelValue"])]),p("div",qe,[i(n(k),{label:"Complete Within Days",modelValue:e.complete_within_days,"onUpdate:modelValue":o=>e.complete_within_days=o,type:"number",min:"1",required:""},null,8,["modelValue","onUpdate:modelValue"]),i(n(k),{label:"From Date",modelValue:e.from_date,"onUpdate:modelValue":o=>e.from_date=o,type:"date",disabled:e.is_child,required:!e.is_child},null,8,["modelValue","onUpdate:modelValue","disabled","required"]),i(n(k),{label:"To Date",modelValue:e.to_date,"onUpdate:modelValue":o=>e.to_date=o,type:"date",disabled:e.is_child,required:!e.is_child},null,8,["modelValue","onUpdate:modelValue","disabled","required"])]),i(n(_e),{label:"Description",modelValue:e.description,"onUpdate:modelValue":o=>e.description=o,rows:"3"},null,8,["modelValue","onUpdate:modelValue"])])]))),128)),i(n(q),{type:"button",onClick:X,variant:"outline",class:"w-full mb-4"},{default:A(()=>a[6]||(a[6]=[x(" + Add Task ")])),_:1,__:[6]}),p("div",Ee,[i(n(q),{type:"button",onClick:ee,variant:"outline",class:"flex-1",disabled:V.value},{default:A(()=>a[7]||(a[7]=[x(" Cancel ")])),_:1,__:[7]},8,["disabled"]),i(n(q),{type:"submit",variant:"solid",theme:"gray",class:"flex-1",loading:V.value},{default:A(()=>[x(S(V.value?"Creating...":"Create Activity"),1)]),_:1},8,["loading"])])],32)])):f("",!0)]))}},De=ne(Pe,[["__scopeId","data-v-7c4ca36d"]]);export{De as default};
//# sourceMappingURL=ActivityForm-BTLIqj30.js.map
